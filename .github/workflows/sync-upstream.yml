name: ğŸ”„ åŒæ­¥ä¸Šæ¸¸ä»“åº“æ›´æ–°

on:
  # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š 8 ç‚¹æ£€æŸ¥æ›´æ–°
  schedule:
    - cron: '0 0 * * *'  # UTC 0:00 = åŒ—äº¬æ—¶é—´ 8:00
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'å¼ºåˆ¶åŒæ­¥ï¼ˆå¿½ç•¥å†²çªï¼‰'
        required: false
        default: 'false'
        type: boolean

jobs:
  sync-upstream:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”§ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: âš™ï¸ é…ç½® Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
    
    - name: ğŸ”— æ·»åŠ ä¸Šæ¸¸ä»“åº“
      run: |
        git remote add upstream https://github.com/hesreallyhim/awesome-claude-code.git || true
        git fetch upstream
    
    - name: ğŸ“Š æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„æäº¤
      id: check-updates
      run: |
        UPSTREAM_COMMIT=$(git rev-parse upstream/main)
        CURRENT_COMMIT=$(git rev-parse HEAD)
        
        echo "upstream_commit=$UPSTREAM_COMMIT" >> $GITHUB_OUTPUT
        echo "current_commit=$CURRENT_COMMIT" >> $GITHUB_OUTPUT
        
        if [ "$UPSTREAM_COMMIT" != "$CURRENT_COMMIT" ]; then
          echo "has_updates=true" >> $GITHUB_OUTPUT
          echo "ğŸ†• å‘ç°ä¸Šæ¸¸æ›´æ–°"
        else
          echo "has_updates=false" >> $GITHUB_OUTPUT
          echo "âœ… å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
        fi
    
    - name: ğŸ”„ åŒæ­¥è‹±æ–‡ç‰ˆæœ¬
      if: steps.check-updates.outputs.has_updates == 'true' || github.event.inputs.force_sync == 'true'
      run: |
        # è·å–ä¸Šæ¸¸çš„ README.md å¹¶ä¿å­˜ä¸º README-en.md
        git show upstream/main:README.md > README-en.md
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
        if git diff --quiet README-en.md; then
          echo "ğŸ“ è‹±æ–‡ç‰ˆæœ¬æ— å˜åŒ–"
        else
          echo "ğŸ“ è‹±æ–‡ç‰ˆæœ¬å·²æ›´æ–°"
          git add README-en.md
        fi
    
    - name: ğŸ“‹ è·å–ä¸Šæ¸¸æ›´æ–°æ‘˜è¦
      if: steps.check-updates.outputs.has_updates == 'true' || github.event.inputs.force_sync == 'true'
      id: get-changes
      run: |
        # è·å–ä¸Šæ¸¸æœ€æ–°çš„æäº¤ä¿¡æ¯
        LATEST_COMMITS=$(git log --oneline upstream/main ^HEAD | head -5)
        echo "latest_commits<<EOF" >> $GITHUB_OUTPUT
        echo "$LATEST_COMMITS" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: ğŸš€ æäº¤æ›´æ–°
      if: steps.check-updates.outputs.has_updates == 'true' || github.event.inputs.force_sync == 'true'
      run: |
        if git diff --staged --quiet; then
          echo "ğŸ“ æ²¡æœ‰æ–‡ä»¶éœ€è¦æ›´æ–°"
        else
          # åˆ›å»ºæäº¤æ¶ˆæ¯
          COMMIT_MSG="ğŸ”„ è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸æ›´æ–°

        ğŸ“‹ ä¸Šæ¸¸æœ€æ–°æäº¤:
        ${{ steps.get-changes.outputs.latest_commits }}

        ğŸ”— ä¸Šæ¸¸æäº¤: ${{ steps.check-updates.outputs.upstream_commit }}
        ğŸ• åŒæ­¥æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

        ---
        æ­¤æ›´æ–°ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ
        åŸå§‹é¡¹ç›®: https://github.com/hesreallyhim/awesome-claude-code"
          
          git commit -m "$COMMIT_MSG"
          git push origin main
          echo "âœ… æ›´æ–°å·²æ¨é€åˆ°è¿œç¨‹ä»“åº“"
        fi
    
    - name: ğŸ“ åˆ›å»ºåŒæ­¥æŠ¥å‘Š Issue
      if: steps.check-updates.outputs.has_updates == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const title = 'ğŸ”„ ä¸Šæ¸¸åŒæ­¥æŠ¥å‘Š - ' + new Date().toISOString().split('T')[0];
          const upstreamCommit = '${{ steps.check-updates.outputs.upstream_commit }}';
          const latestCommits = '${{ steps.get-changes.outputs.latest_commits }}';
          const syncTime = new Date().toLocaleString('zh-CN', {timeZone: 'Asia/Shanghai'});
          
          const body = '## ğŸ“Š åŒæ­¥æ‘˜è¦\n\n' +
            'ğŸ”— **ä¸Šæ¸¸ä»“åº“**: [hesreallyhim/awesome-claude-code](https://github.com/hesreallyhim/awesome-claude-code)\n' +
            'ğŸ“… **åŒæ­¥æ—¶é—´**: ' + syncTime + ' (åŒ—äº¬æ—¶é—´)\n' +
            'ğŸ†” **ä¸Šæ¸¸æäº¤**: `' + upstreamCommit + '`\n\n' +
            '## ğŸ“‹ ä¸Šæ¸¸æœ€æ–°æ›´æ”¹\n\n' +
            '```\n' + latestCommits + '\n```\n\n' +
            '## âœ… è‡ªåŠ¨åŒæ­¥å®Œæˆ\n\n' +
            '- [x] è‹±æ–‡ç‰ˆæœ¬ (README-en.md) å·²æ›´æ–°\n' +
            '- [x] ä¸­æ–‡ç‰ˆæœ¬ (README.md) ä¿æŒä¸å˜\n' +
            '- [x] ç¹ä½“ä¸­æ–‡ç‰ˆæœ¬ (README-zh-TW.md) ä¿æŒä¸å˜\n\n' +
            '## ğŸ“ åç»­è¡ŒåŠ¨\n\n' +
            'å¦‚æœä¸Šæ¸¸æœ‰é‡å¤§å†…å®¹æ›´æ–°ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨æ›´æ–°ä¸­æ–‡ç¿»è¯‘ç‰ˆæœ¬ï¼š\n' +
            '- [ ] æ£€æŸ¥è‹±æ–‡ç‰ˆæœ¬çš„æ–°å¢å†…å®¹\n' +
            '- [ ] æ›´æ–°ç®€ä½“ä¸­æ–‡ç¿»è¯‘ (README.md)\n' +
            '- [ ] æ›´æ–°ç¹ä½“ä¸­æ–‡ç¿»è¯‘ (README-zh-TW.md)\n' +
            '- [ ] æ›´æ–°æœ¯è¯­å¯¹ç…§è¡¨ (docs/i18n/terminology.md)\n\n' +
            '---\n*æ­¤æŠ¥å‘Šç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*';
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['ğŸ”„ è‡ªåŠ¨åŒæ­¥', 'ğŸ“ éœ€è¦ç¿»è¯‘']
          });
    
    - name: ğŸ“¢ åŒæ­¥å®Œæˆé€šçŸ¥
      if: steps.check-updates.outputs.has_updates == 'true' || github.event.inputs.force_sync == 'true'
      run: |
        echo "ğŸ‰ åŒæ­¥å®Œæˆï¼"
        echo "ğŸ“Š ç»Ÿè®¡ä¿¡æ¯:"
        echo "  - ä¸Šæ¸¸æäº¤: ${{ steps.check-updates.outputs.upstream_commit }}"
        echo "  - åŒæ­¥æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ï¿½ï¿½ è¯·æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°ä¸­æ–‡ç¿»è¯‘ç‰ˆæœ¬" 